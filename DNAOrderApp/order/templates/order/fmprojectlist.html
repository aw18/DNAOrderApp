{% extends "base_template.html" %} 
{% load render_table from django_tables2 %}
{% load replace %}

{% block title %}Project List{% endblock title %}


{% block extra_css_js %}
<link href="{{ STATIC_URL }}bootstrap-modal/css/bootstrap-modal.css" rel="stylesheet" media="screen">
<link href="{{ STATIC_URL }}bootstrap-modal/js/bootstrap-modalmanager.js" rel="text/javascript" media="screen">
<link href="{{ STATIC_URL }}bootstrap-modal/js/bootstrap-modal.js" rel="text/javascript" media="screen">
<link rel="stylesheet" href="{{ STATIC_URL }}django_tables2/themes/paleblue/css/screen.css" />
<style>
#phenocompo{
					max-height: 320px; 
					height: 100%;
					border: solid;
}
</style>

<script type="text/javascript">
function getCookie(name) {
	var cookieValue = null;
	if (document.cookie && document.cookie != '') {
		var cookies = document.cookie.split(';');
		for (var i = 0; i < cookies.length; i++) {
			var cookie = jQuery.trim(cookies[i]);
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) == (name + '=')) {
            	cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            	break;
            }
        }
    }
    return cookieValue;
}
var csrftoken = getCookie('csrftoken');

function refreshPhenotypeList() {
  $("#current-list").empty();
  for(i=0; i< source.length; i++)
    $("#current-list").append("<li class=\"active\"><a href=\"#\">" + source[i] + "<i class=\"icon-remove close\" data-dismiss=\"alert\"></i></a></li>");
}
var source = ['alisso','balexandre'];


$(document).ready(function() {
	$(".collapse").collapse();

	// To Add a Phenotype
	$("#add_a_phenotype_form").ajaxForm({
		url: '/order/api/handle_phenotype/ADD/',
		type: "POST",
		resetForm : true,
		headers : {"X-CSRFToken" : csrftoken},
		success : function(data) {
			console.log(data);
			$('table#phenotype-table').replaceWith(data);
			$('div#alert-signs').html("<div class=\"alert alert-success\"><b>Good Job!</b> You have successfully added a Phenotype!</div>");
		},
		error : function(data) {
			$('div#alert-signs').html("<div class=\"alert alert-error\"><b>Uh Oh! </b> Ajax Failed! </div>");
		}
	});
	console.log("done loading phenotype form");

	//Changing Modal size dynamically
	$('#phenotypelist').on('show', function(){
		console.log("width" + window.innerWidth + "height " + window.innerHeight +"margin-left" + -(window.innerWidth/2));
		// $('#phenotypelist').css({ 
		// 							width : window.innerWidth+'px', 
		// 							height : window.innerHeight+'px', 
		// 							'margin-left': -(window.innerWidth/2), 
		// 							'max-height': window.innerHeight+'px', 
		// 							'max-width': window.innerWidth+'px',

		// 			});
		$('#phenotypelist').css({ 
										// width : '1200px', 
										width : '100%',
										height : '100%', 
										'margin-left' : -(window.innerWidth/2)+60,
										// 'margin-left' : '-600px',
										'margin-top' : -window.innerHeight*0.08+'px',
										'max-width' : window.innerWidth-120+'px',
										// 'max-width' : '1500px',
										'max-height' : window.innerHeight-60+'px',
										// 'max-height': '600px',
										'border' : 'solid',
		});
	});

	//Changing the phenotype section size
	$('.phenotype-section').css({
									'max-height': '350px', 
									height: '100%',
									'border': 'solid',
	});

	//TypeHead Dynamic Phenotype list
	$('.typeahead').typeahead({
		source : source,
		items: 16
	});

	$('form').submit(function(e) {

    e.preventDefault(); // don't submit the form
    
    var txt = $('.typeahead').val(); // get the current item
    console.log(txt);
    $('.typeahead').val(""); // clean the input
    source.push(txt); // add it to the source
    refreshPhenotypeList(); // refresh the list

	});

	refreshPhenotypeList();

});

function deletePhenotype(elt) {
	var value = $(elt).attr("value");

	console.log("in deletePhenotype" + $(elt).attr("name"));
	var name = $(elt).attr("name");

	$.ajax({
		url: '/order/api/handle_phenotype/DELETE/'+value,
		type: "DELETE",
		headers : {"X-CSRFToken" : csrftoken},
	}).done( function(data) {
		console.log(data);
		$('table#phenotype-table').replaceWith(data);
		$('div#alert-signs').html("<div class=\"alert alert-success\"><b>Good Job!</b> You have successfully deleted a phenotype!</div>");
	}).fail( function(){
		$('div#alert-signs').html("<div class=\"alert alert-error\"><b>Uh Oh! </b> Ajax Failed! </div>");
	});

	return false;
}

function getPhenotypeList(elt){
	console.log("getpheno!")
	var proj_name = $(elt).attr("value");
	console.log(proj_name)

	$.ajax({
		url: '/order/get_phenolist/'+proj_name,
		headers : {"X-CSRFToken" : csrftoken},
	}).done( function(data){
		console.log(data);
		// $('table#phenotype-table').replaceWith(data);
	}).fail( function(){
		alert("failed ajax - in getPhenotypeList");
	});
	return false;
}

// function getTop3PhenotypeList(elt){
// 	console.log("in gettop3 phenolist");
// 	var ss = $(elt).attr("value");
// 	console.log(ss);

// 	$.ajax({
// 		url: '/order/get_top3phenolist/'+ss,
// 		headers : {"X-CSRFToken" : csrftoken},
// 	}).done( function(data){
// 		console.log(data);
// 		$('td#top3phenolist').replaceWith(data);
// 	}).fail( function(){
// 		alert("failed ajax - in getTop3Phenotypelist");
// 	});

// 	return false;
// }
</script>

{% endblock extra_css_js %}

{% block extrahead %}
#extract-now, #extract-panel{
padding:5px;
text-align:center;
background-color:#e5eecc;
border:solid 1px #c3c3c3;
}

#extract-panel
{
	padding:50px;
	display:none;
}
{% endblock extrahead %}

{% block active-navbar %} 
<!-- NAVBAR IF WANTED -->
{% endblock active-navbar %}

{% block content %}
<div class="container">

	{% block section_title %}<h1> Welcome {{ username }} ! Status: Faculty Member </h1>{% endblock section_title %}

	<div class="container" id="project-section">
		<!--****************** PROJECT TABLE ***********************-->
		<div id="alert-signs">
			{{ alert_msg|safe }}
		</div>
		<br />
		<h3> All Projects </h3>

		<!-- <table class="table table-hover" id="project-table">
			<tr>
				<th> Project Name </th>
				<th> Created On </th>
				<th> Last updated </th>
				<th> Delete? </th>
			</tr>
			{% for up in userprojectlist_all %}
			<tr id="{{up.pk}}">
				<td>{{ up.project_name }}</td>
				<td>{{ up.date_created }}</td>
				<td>{{ up.last_updated }}</td>
				<td> <a id="delete-project{{up.pk}}" name="DEL_PROJ" class="btn delete" value="{{up.pk}}" onclick="deleteProject(this)"><i class="icon-remove"></i></a></td>
			</tr>

			{% endfor %}
		</table> -->
		<div id="PARENT" class="accordion"></div>
		<table class="table table-striped" id="project-table">
			<tr>
				<th> </th>
				<th> Project Name </th>
				<th> Date Created </th>
				<th> Last Updated </th>
				<th> Sample Submissions Status </th>
				<th> Phenotype list Status </th>
			</tr>
			{% for proj, sslist in proj_ss_dict.items %}
			<tr class="GroupA">
				<td>
					<div class="accordion-group">
						<div class="accordion-heading">
							<a href="#{{proj.project_name|replace}}" data-parent="#PARENT" data-toggle="collapse" class="accordion-toggle">
								<i id="toggle" class="icon-plus"></i>
							</a>
						</div>
					</div>
				</td>
				<td>
					{{ proj.project_name }}
				</td>
				<td>
					{{ proj.date_created }}
				</td>
				<td>
					{{ proj.last_updated }}
				</td>
				{% if sslist|length == 0 %}
				<td>
					<span class="label label-warning"><i class="icon-warning-sign"></i> No Sample Submissions</span>
				</td>
				{% else %}
				<td>
					<i class="icon-list-alt"></i> {{ sslist|length }} Sample Submission(s)
				</td>
				{% endif %}
				<td>
					<i class="icon-warning-sign"></i> Placeholder - displaying number of phenotype lists included
				</td>
			</tr>
			<tr>
				<td class="more"></td>
				<td colspan="5" class="more">
					<div class="accordion-body in collapse" id="{{ proj.project_name|replace }}">
						<div class="accordion-inner" style="border:none">
							<table class="table table-bordered" style="border:solid 1px">
								<tr>
									<th>Sample Submission</th>
									<th>Phenotype List</th>
									<th> External Collaborator (Source) </th>
									<th> # of Samples </th>
									<th> Date Created </th>
									<th> Last Updated </th>
								</tr>
								{% for ss in sslist %}
								<tr>
									<td>{{ ss.sample_submission_name }}</td>
									<td id="top3phenolist">
										<ul>
										{% for ss_select, phenolist in ss_pheno_dict.items %}
											{% if ss_select == ss %}
												<b>{{ss_select}}</b>
												{% for pheno in phenolist|slice:":3" %}
													<li>{{ pheno }}</li>
												{% endfor %}
												<!-- To SEE THE FULL LIST UNCOMMENT THIS -->
												<!-- {% for pheno in phenolist %}
													<li>{{ pheno }}</li>
												{% endfor %} -->
												<!-- UNCOMMENT UP TO HERE -->
											{% endif %}
										{% endfor %}
										<a href="#phenotypelist" class="pull-right" data-toggle="modal" value="{{ss.sample_submission_name}}" onclick="getPhenotypeList(this)">>>See More</a></td>
										</ul>
									<td>{{ ss.source }}</td>
									<td>{{ ss.sample_num }}</td>
									<td>{{ ss.date_created }}</td>
									<td>{{ ss.last_updated }}</td>
								</tr>
								{% empty %}
								<b> Please Add Sample Submissions </b>
								{% endfor %}
							</table>
						</div>
					</div>
				</td>
			</tr>
			{% endfor %}
		</table>


		<!--****************** ADD A PROJECT FORM ***********************-->
		<div id="add_a_project_panel"> 
			<h3> Add A Project </h3>

			<b>Note: This interface for adding a Project is just for development purposes; in reality, I will get a list of projects that is
				associated with the specific user.</b>
				<br />
				<br />
				<form class="add_a_project" method="post" id="add_a_project_form">
					{% csrf_token %}
					<table>
						{{ userprojectform }}
					</table>
					<br />
					<button id="add-a-project-button" class="btn btn-primary" type="submit" name="ADD_PROJ">Create a Project</button>
				</form>
			</div>
			<br />
			<hr />
			<br />
			<br />


		</div>
	</div>

</div>

<!--*************************** NEW PHENOTYPE MODAL ******************************-->
<div class="container">
	<div id="phenotypelist" class="modal hide fade container-fluid" tabindex="-1" role="dialog">
		<div class="modal-header">
			<button type="button" class="close" data-dismiss="modal">x</button>
			<h4 id-"modallabel">{{ samplesubmission_pheno }} / Phenotype List</h4>
		</div>
		
		<div class="phenotype-section"> <!--here is the style-->
			<div class="container-fluid">
				<div class="row-fluid" id="phenotype_list_viewer">
					<div class="span4" id="phenocompo">
						<div class="modal-body" id="phenocompo" style="padding:0">
						<!--*************** PHENOTYPE LIST ****************************-->
						<ul id="current-list" class="nav nav-pills nav-stacked">
						</ul>
					</div>

					</div>
					<div id="viewer" class="span8" id="phenocompo">
						<div class="modal-body" id="phenocompo">
						HKDJFALKSJDFLAKSDFLSFD
					</div>
					</div>
				</div>
			</div>
		</div>

		<div class="modal-footer" style="padding:5px; border: solid red;">
			<div class="container-fluid">
				<div class="row-fluid">
					<div class="span10">
						<form action="#">
							<div class="well">
								<input type="text" class="span12 typeahead" data-provide="typeahead" />
							</div>
						</form>
					</div>
					<div class="span2">
						<div class="row-fluid">
							<div class="span5">
								<a href="#" class="btn pull-right" data-dismiss="modal">Cancel</a>
							</div>
							<div class="span1"></div>
							<div class="span6">
								<a href="#" class="btn btn-primary pull-right">Save changes</a>
							</div>
						</div>
					</div>
				</div>
			</div>

		</div>
	</div>
</div>

<!--*************************** END OF NEW PHENOTYPE MODAL ************************-->




{% endblock content %}

<!-- <table class="table table-striped" id="project-table">
			<tr class="GroupA">
				<td>
					<div class="accordion-group">
						<div class="accordion-heading">
							<a href="#DESC" data-parent="#PARENT" data-toggle="collapse" class="accordion-toggle">
								<i id="toggle" class="icon-plus"></i>
							</a>
						</div>
					</div>
				</td>
				<td>
					ProjectNameTest
				</td>
				<td>
					January 3, 2013
				</td>
				<td>
					January 4, 2013
				</td>
			</tr>
			<tr>
				<td class="more"></td>
				<td colspan="3" class="more">
					<div class="accordion-body in collapse" id="DESC">
						<div class="accordion-inner" style="border:none">
							<table class="table table-bordered" style="border:solid 1px">
								<tr>
									<th>Sample Submission</th>
									<th>Phenotype List</th>
									<th> Source </th>
									<th> # of Samples </th>
									<th> Date Created </th>
									<th> Last Updated </th>
								</tr>
								<tr>
									<td>Sample Submission Test</td>
									<td>PhenotypeListTest </td>
									<td> Addenbrokes Hospital </td>
									<td> 110 </td>
									<td> January 4, 2013 </td>
									<td> January 4, 2013 </td>
								</tr>
								<tr>
									<td>Sample Submission Test 2</td>
									<td>PhenotypeListTest 2</td>
									<td> Addenbrokes Hospital </td>
									<td> 3000 </td>
									<td> January 4, 2013 </td>
									<td> January 4, 2013 </td>
								</tr>
							</table>
						</div>
					</div>
				</td>
			</tr>
			<tr class="GroupB">
				<td width="20">
					<div class="accordion-group">
						<div class="accordion-heading">
							<a href="#DESC1" data-parent="#PARENT" data-toggle="collapse" class="accordion-toggle">
								<i id="toggle" class="icon-plus"></i>
							</a>
						</div>
					</div>
				</td>
				<td>
					ProjectNameTest
				</td>
				<td>
					January 3, 2013
				</td>
				<td>
					January 4, 2013
				</td>
			</tr>
			<tr>
				<td class="more"></td>
				<td colspan="3" class="more">
					<div class="accordion-body in" id="DESC">
						<div class="accordion-inner" style="border:none">
							<table class="table table-bordered" style="border:solid 1px">
								<tr>
									<th>Sample Submission</th>
									<th>Phenotype List</th>
									<th> Source </th>
									<th> # of Samples </th>
									<th> Date Created </th>
									<th> Last Updated </th>
								</tr>
								<tr>
									<td>Sample Submission Test</td>
									<td>PhenotypeListTest </td>
									<td> Addenbrokes Hospital </td>
									<td> 110 </td>
									<td> January 4, 2013 </td>
									<td> January 4, 2013 </td>
								</tr>
								<tr>
									<td>Sample Submission Test 2</td>
									<td>PhenotypeListTest 2</td>
									<td> Addenbrokes Hospital </td>
									<td> 3000 </td>
									<td> January 4, 2013 </td>
									<td> January 4, 2013 </td>
								</tr>
							</table>
						</div>
					</div>
				</td>
			</tr>
		</table> -->









<!--******************** OLD PHENOTYPE MODAL **************************-->
<!-- <div id="phenotypelist" class="modal hide fade" tabindex="-1" role="dialog" style="width:window.innerWidth+'px'">
	<div class="modal-header">
		<button type="button" class="close" data-dismiss="modal">x</button>
		<h3 id="modallabel">Phenotype list for Sample Submission "SAMPLE SUBMISSION NAME"</h3>
	</div>
	<div class="modal-body">
		<div class="container" id="phenotype-section">
			<!****************** PHENOTYPE TABLE ***********************-->
			<!-- <h3> All Phenotypes </h3>

			<table class="table table-striped table-bordered table-hover" id ="phenotype-table">
				<tr>
					<th> Phenotype Name </th>
					<th> Phenotype Type </th>
					<th> Phenotype Description </th>
					<th> Phenotype Definition </th>
					<th> Delete? </th>
				</tr>
				{% for p in phenotypelist_all %}
				<tr id="{{p.pk}}">
					<td>{{ p.phenotype_name }}</td>
					<td>{{ p.phenotype_type_id }}</td>
					<td>{{ p.phenotype_description }}</td>
					<td>{{ p.phenotype_definition }}</td>
					<td> 
						<a id="delete-phenotype{{p.pk}}" name="DEL_PHENO" class="btn delete" value="{{p.pk}}" onclick="deletePhenotype(this)"><i class="icon-remove"></i></a>
					</td>
				</tr>
				{% endfor %}
			</table> -->

			<!--****************** ADD A PHENOTYPE FORM ***********************-->
			<!-- <div id="add_a_phenotype_panel"> 
				<h3> Add A Phenotype </h3>
				<b>NOTE: PHENOTYPE DEFINITION CAN USE THE TAG-IT FEATURE http://aehlke.github.io/tag-it/ </b>
				<br />
				<form class="add_a_phenotype" method="post" id="add_a_phenotype_form">
					{% csrf_token %}
					<table>
						{{ phenotypeform }}
					</table>
					<br />
					<button id="add-pheno" class="btn btn-primary" type="submit">Create a Phenotype</button>
				</form>
			</div>
		</div>
	</div>
	<div class="modal-footer">
	</div>
</div> -->
<!--- ********************************* END OF PHENOTYPE MODAL *****************************-->

